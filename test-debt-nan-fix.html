<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test - Correction NaN dans les Dettes</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .button {
            background: #dc3545;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        .button:hover {
            background: #c82333;
        }
        .success {
            background: #28a745;
        }
        .success:hover {
            background: #218838;
        }
        .info {
            background: #17a2b8;
        }
        .info:hover {
            background: #138496;
        }
        .status {
            margin: 20px 0;
            padding: 15px;
            border-radius: 5px;
            background: #e9ecef;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin: 20px 0;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .test-section {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Test - Correction des NaN dans les Dettes</h1>
        <p>Test des corrections apport√©es pour √©liminer les "NaN%" dans la gestion des dettes.</p>
        
        <div class="status" id="status">
            Pr√™t √† tester les corrections...
        </div>
        
        <div class="test-section">
            <h2>Test de la fonction formatCurrency</h2>
            <button class="button info" onclick="testFormatCurrency()">Tester formatCurrency</button>
            <div id="formatTest" class="log"></div>
        </div>
        
        <div class="test-section">
            <h2>Test des calculs de pourcentages</h2>
            <button class="button info" onclick="testPercentageCalculations()">Tester les pourcentages</button>
            <div id="percentageTest" class="log"></div>
        </div>
        
        <div class="test-section">
            <h2>Test avec donn√©es vides</h2>
            <button class="button" onclick="testEmptyData()">Tester avec donn√©es vides</button>
            <button class="button success" onclick="testWithData()">Tester avec donn√©es</button>
            <div id="emptyTest" class="log"></div>
        </div>
        
        <div class="test-section">
            <h2>Actions</h2>
            <button class="button" onclick="clearAllData()">Vider toutes les donn√©es</button>
            <button class="button success" onclick="goToDebtManagement()">Aller √† la gestion des dettes</button>
        </div>
        
        <div class="log" id="log"></div>
    </div>

    <script>
        function log(message) {
            const logElement = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logElement.textContent += `[${timestamp}] ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
        }

        function updateStatus(message, type = 'info') {
            const statusElement = document.getElementById('status');
            statusElement.textContent = message;
            statusElement.style.background = type === 'success' ? '#d4edda' : 
                                           type === 'error' ? '#f8d7da' : '#e9ecef';
        }

        // Fonction formatCurrency corrig√©e (copie de celle du composant)
        function formatCurrency(amount) {
            // G√©rer les valeurs NaN, undefined, null
            const safeAmount = isNaN(amount) || amount === null || amount === undefined ? 0 : amount;
            return new Intl.NumberFormat('fr-FR').format(safeAmount) + ' FG';
        }

        function testFormatCurrency() {
            log('üß™ Test de la fonction formatCurrency...');
            
            const testValues = [
                { input: 150000, expected: '150 000 FG' },
                { input: 0, expected: '0 FG' },
                { input: NaN, expected: '0 FG' },
                { input: null, expected: '0 FG' },
                { input: undefined, expected: '0 FG' },
                { input: 'invalid', expected: '0 FG' },
                { input: 250000.50, expected: '250 000,5 FG' }
            ];
            
            let allPassed = true;
            testValues.forEach((test, index) => {
                const result = formatCurrency(test.input);
                const passed = result === test.expected;
                allPassed = allPassed && passed;
                
                const status = passed ? '‚úÖ' : '‚ùå';
                log(`${status} Test ${index + 1}: ${test.input} ‚Üí ${result} (attendu: ${test.expected})`);
            });
            
            const testElement = document.getElementById('formatTest');
            testElement.textContent = allPassed ? '‚úÖ Tous les tests formatCurrency ont r√©ussi' : '‚ùå Certains tests formatCurrency ont √©chou√©';
            
            updateStatus(allPassed ? 'Tests formatCurrency r√©ussis' : 'Tests formatCurrency √©chou√©s', allPassed ? 'success' : 'error');
        }

        function testPercentageCalculations() {
            log('üß™ Test des calculs de pourcentages...');
            
            const testCases = [
                { totalAmount: 0, paidAmount: 0, expected: 0 },
                { totalAmount: 100000, paidAmount: 50000, expected: 50 },
                { totalAmount: 100000, paidAmount: 0, expected: 0 },
                { totalAmount: 100000, paidAmount: 100000, expected: 100 },
                { totalAmount: 0, paidAmount: 100000, expected: 0 },
                { totalAmount: NaN, paidAmount: 50000, expected: 0 },
                { totalAmount: 100000, paidAmount: NaN, expected: 0 }
            ];
            
            let allPassed = true;
            testCases.forEach((test, index) => {
                const result = test.totalAmount > 0 ? Math.round((test.paidAmount / test.totalAmount) * 100) : 0;
                const passed = result === test.expected;
                allPassed = allPassed && passed;
                
                const status = passed ? '‚úÖ' : '‚ùå';
                log(`${status} Test ${index + 1}: ${test.totalAmount}/${test.paidAmount} ‚Üí ${result}% (attendu: ${test.expected}%)`);
            });
            
            const testElement = document.getElementById('percentageTest');
            testElement.textContent = allPassed ? '‚úÖ Tous les tests de pourcentages ont r√©ussi' : '‚ùå Certains tests de pourcentages ont √©chou√©';
            
            updateStatus(allPassed ? 'Tests de pourcentages r√©ussis' : 'Tests de pourcentages √©chou√©s', allPassed ? 'success' : 'error');
        }

        function testEmptyData() {
            log('üß™ Test avec donn√©es vides...');
            
            // Simuler des donn√©es vides
            const emptyDebts = [];
            const stats = {
                summary: {
                    totalDebts: 0,
                    totalAmount: 0,
                    totalPaid: 0,
                    totalRemaining: 0,
                    overdueCount: 0
                }
            };
            
            // Test des calculs avec donn√©es vides
            const paidPercentage = stats.summary.totalAmount > 0 ? Math.round((stats.summary.totalPaid / stats.summary.totalAmount) * 100) : 0;
            const remainingPercentage = stats.summary.totalAmount > 0 ? Math.round((stats.summary.totalRemaining / stats.summary.totalAmount) * 100) : 0;
            
            log(`üìä Donn√©es vides:`);
            log(`  - Total dettes: ${stats.summary.totalDebts}`);
            log(`  - Montant total: ${formatCurrency(stats.summary.totalAmount)}`);
            log(`  - Montant pay√©: ${formatCurrency(stats.summary.totalPaid)}`);
            log(`  - Montant restant: ${formatCurrency(stats.summary.totalRemaining)}`);
            log(`  - Pourcentage pay√©: ${paidPercentage}%`);
            log(`  - Pourcentage restant: ${remainingPercentage}%`);
            
            const hasNaN = isNaN(paidPercentage) || isNaN(remainingPercentage);
            const testElement = document.getElementById('emptyTest');
            testElement.textContent = hasNaN ? '‚ùå Des NaN d√©tect√©s avec des donn√©es vides' : '‚úÖ Aucun NaN avec des donn√©es vides';
            
            updateStatus(hasNaN ? 'Probl√®me d√©tect√© avec donn√©es vides' : 'OK avec donn√©es vides', hasNaN ? 'error' : 'success');
        }

        function testWithData() {
            log('üß™ Test avec donn√©es de test...');
            
            // Cr√©er des donn√©es de test
            const testDebts = [
                {
                    id: 1,
                    customerName: 'Test Client 1',
                    totalPrice: 200000,
                    paidAmount: 100000,
                    remainingAmount: 100000,
                    status: 'partial'
                },
                {
                    id: 2,
                    customerName: 'Test Client 2',
                    totalPrice: 150000,
                    paidAmount: 0,
                    remainingAmount: 150000,
                    status: 'pending'
                }
            ];
            
            // Calculer les statistiques
            const totalAmount = testDebts.reduce((sum, debt) => sum + (debt.totalPrice || 0), 0);
            const paidAmount = testDebts.reduce((sum, debt) => sum + (debt.paidAmount || 0), 0);
            const remainingAmount = testDebts.reduce((sum, debt) => sum + (debt.remainingAmount || 0), 0);
            
            const paidPercentage = totalAmount > 0 ? Math.round((paidAmount / totalAmount) * 100) : 0;
            const remainingPercentage = totalAmount > 0 ? Math.round((remainingAmount / totalAmount) * 100) : 0;
            
            log(`üìä Donn√©es de test:`);
            log(`  - Total dettes: ${testDebts.length}`);
            log(`  - Montant total: ${formatCurrency(totalAmount)}`);
            log(`  - Montant pay√©: ${formatCurrency(paidAmount)}`);
            log(`  - Montant restant: ${formatCurrency(remainingAmount)}`);
            log(`  - Pourcentage pay√©: ${paidPercentage}%`);
            log(`  - Pourcentage restant: ${remainingPercentage}%`);
            
            const hasNaN = isNaN(paidPercentage) || isNaN(remainingPercentage);
            const testElement = document.getElementById('emptyTest');
            testElement.textContent = hasNaN ? '‚ùå Des NaN d√©tect√©s avec des donn√©es' : '‚úÖ Aucun NaN avec des donn√©es';
            
            updateStatus(hasNaN ? 'Probl√®me d√©tect√© avec donn√©es' : 'OK avec donn√©es', hasNaN ? 'error' : 'success');
        }

        function clearAllData() {
            log('üßπ Nettoyage complet...');
            try {
                localStorage.clear();
                sessionStorage.clear();
                log('‚úÖ Toutes les donn√©es supprim√©es');
                updateStatus('‚úÖ Toutes les donn√©es supprim√©es', 'success');
            } catch (error) {
                log('‚ùå Erreur: ' + error.message);
                updateStatus('‚ùå Erreur', 'error');
            }
        }

        function goToDebtManagement() {
            log('üîó Redirection vers la gestion des dettes...');
            window.location.href = '/admin/debts';
        }

        // Tests automatiques au chargement
        window.onload = function() {
            log('üöÄ Page de test des corrections NaN charg√©e');
            testFormatCurrency();
            testPercentageCalculations();
            testEmptyData();
        };
    </script>
</body>
</html>
