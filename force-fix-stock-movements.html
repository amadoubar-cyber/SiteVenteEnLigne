<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Force Fix - Mouvements de Stock</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 20px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .button {
            background: #007bff;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        .button:hover {
            background: #0056b3;
        }
        .success {
            background: #28a745;
        }
        .success:hover {
            background: #218838;
        }
        .danger {
            background: #dc3545;
        }
        .danger:hover {
            background: #c82333;
        }
        .warning {
            background: #ffc107;
            color: #212529;
        }
        .warning:hover {
            background: #e0a800;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin: 20px 0;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .section {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin: 15px 0;
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .stats-display {
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
            text-align: center;
        }
        .stats-number {
            font-size: 2em;
            font-weight: bold;
            color: #007bff;
        }
        .stats-label {
            color: #6c757d;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Force Fix - Mouvements de Stock</h1>
        <p><strong>Solution directe pour corriger d√©finitivement le probl√®me des mouvements de stock qui affichent des z√©ros.</strong></p>
        
        <div id="status" class="status warning">
            Pr√™t √† forcer la correction...
        </div>
        
        <div class="section">
            <h2>üìä √âtat Actuel</h2>
            <button class="button" onclick="checkCurrentState()">V√©rifier l'√©tat actuel</button>
            <button class="button" onclick="showProductsAndSales()">Afficher produits et ventes</button>
            <div id="current" class="log"></div>
        </div>
        
        <div class="section">
            <h2>üîß Correction Forc√©e</h2>
            <button class="button success" onclick="forceFixStockMovements()">FORCER LA CORRECTION</button>
            <button class="button warning" onclick="createAllMovements()">Cr√©er tous les mouvements</button>
            <button class="button" onclick="syncWithSales()">Synchroniser avec les ventes</button>
            <div id="fix" class="log"></div>
        </div>
        
        <div class="section">
            <h2>üìà Statistiques Apr√®s Correction</h2>
            <button class="button" onclick="showCorrectedStats()">Afficher les statistiques</button>
            <div id="stats" class="log"></div>
        </div>
        
        <div class="section">
            <h2>üß™ Test Final</h2>
            <button class="button success" onclick="finalTest()">Test final</button>
            <button class="button" onclick="goToStockMovement()">Aller aux mouvements de stock</button>
            <div id="test" class="log"></div>
        </div>
    </div>

    <script>
        function log(message, targetId = 'current') {
            const logElement = document.getElementById(targetId);
            const timestamp = new Date().toLocaleTimeString();
            logElement.textContent += `[${timestamp}] ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
        }

        function updateStatus(message, type = 'warning') {
            const statusElement = document.getElementById('status');
            statusElement.textContent = message;
            statusElement.className = `status ${type}`;
        }

        function checkCurrentState() {
            log('üîç V√âRIFICATION DE L\'√âTAT ACTUEL');
            log('='.repeat(40));
            
            const products = JSON.parse(localStorage.getItem('koula_products') || '[]');
            const sales = JSON.parse(localStorage.getItem('salesData') || '[]');
            const movements = JSON.parse(localStorage.getItem('stockMovements') || '[]');
            
            log(`üì¶ Produits: ${products.length}`);
            log(`üí∞ Ventes: ${sales.length}`);
            log(`üìä Mouvements: ${movements.length}`);
            
            if (products.length > 0) {
                log('\nProduits trouv√©s:');
                products.forEach((product, index) => {
                    log(`  ${index + 1}. ${product.name} - Stock: ${product.stock || 0} - Type: ${product.productType || 'N/A'}`);
                });
            }
            
            if (sales.length > 0) {
                log('\nVentes trouv√©es:');
                sales.forEach((sale, index) => {
                    log(`  ${index + 1}. ${sale.productName || 'Produit inconnu'} - Quantit√©: ${sale.quantity || 1} - Prix: ${sale.totalPrice || sale.amount || 'N/A'} FG`);
                });
            }
            
            if (movements.length > 0) {
                log('\nMouvements trouv√©s:');
                movements.forEach((movement, index) => {
                    log(`  ${index + 1}. ${movement.productName || 'Produit inconnu'} - ${movement.type === 'in' ? 'Entr√©e' : 'Sortie'} - Quantit√©: ${movement.quantity}`);
                });
            } else {
                log('\n‚ùå PROBL√àME: Aucun mouvement de stock trouv√©!');
                log('üí° SOLUTION: Cr√©er des mouvements pour tous les produits et ventes');
            }
        }

        function showProductsAndSales() {
            log('üì¶ PRODUITS ET VENTES D√âTAILL√âS:', 'current');
            log('='.repeat(40), 'current');
            
            const products = JSON.parse(localStorage.getItem('koula_products') || '[]');
            const sales = JSON.parse(localStorage.getItem('salesData') || '[]');
            
            log(`\nPRODUITS (${products.length}):`, 'current');
            products.forEach((product, index) => {
                log(`\n${index + 1}. ${product.name}`, 'current');
                log(`   ID: ${product._id}`, 'current');
                log(`   Stock: ${product.stock || 0}`, 'current');
                log(`   Prix: ${product.price || 0} FG`, 'current');
                log(`   Type: ${product.productType || 'N/A'}`, 'current');
                log(`   Cat√©gorie: ${product.category || 'N/A'}`, 'current');
                log(`   Cr√©√©: ${product.createdAt ? new Date(product.createdAt).toLocaleString() : 'N/A'}`, 'current');
            });
            
            log(`\nVENTES (${sales.length}):`, 'current');
            sales.forEach((sale, index) => {
                log(`\n${index + 1}. ${sale.productName || 'Produit inconnu'}`, 'current');
                log(`   Client: ${sale.customerName || 'N/A'}`, 'current');
                log(`   Quantit√©: ${sale.quantity || 1}`, 'current');
                log(`   Prix unitaire: ${sale.unitPrice || sale.price || 'N/A'} FG`, 'current');
                log(`   Prix total: ${sale.totalPrice || sale.amount || 'N/A'} FG`, 'current');
                log(`   Statut: ${sale.status || 'N/A'}`, 'current');
                log(`   Date: ${sale.createdAt ? new Date(sale.createdAt).toLocaleString() : 'N/A'}`, 'current');
            });
        }

        function forceFixStockMovements() {
            log('üîß CORRECTION FORC√âE DES MOUVEMENTS DE STOCK:', 'fix');
            log('='.repeat(50), 'fix');
            
            try {
                const products = JSON.parse(localStorage.getItem('koula_products') || '[]');
                const sales = JSON.parse(localStorage.getItem('salesData') || '[]');
                const existingMovements = JSON.parse(localStorage.getItem('stockMovements') || '[]');
                
                log(`üì¶ ${products.length} produits trouv√©s`, 'fix');
                log(`üí∞ ${sales.length} ventes trouv√©es`, 'fix');
                log(`üìä ${existingMovements.length} mouvements existants`, 'fix');
                
                // 1. Cr√©er des mouvements initiaux pour tous les produits
                const initialMovements = [];
                products.forEach(product => {
                    // V√©rifier si le produit a d√©j√† des mouvements
                    const hasMovements = existingMovements.some(m => m.productId === product._id);
                    
                    if (!hasMovements && product.stock > 0) {
                        const initialMovement = {
                            _id: 'initial-' + product._id + '-' + Date.now(),
                            productId: product._id,
                            productName: product.name,
                            type: 'in',
                            quantity: product.stock,
                            reason: 'Stock initial',
                            category: product.productType || 'construction',
                            notes: 'Mouvement initial cr√©√© automatiquement',
                            date: product.createdAt || new Date().toISOString(),
                            createdAt: new Date().toISOString(),
                            reference: 'INIT-' + product._id.substring(0, 8).toUpperCase()
                        };
                        initialMovements.push(initialMovement);
                    }
                });
                
                log(`‚úÖ ${initialMovements.length} mouvements initiaux cr√©√©s`, 'fix');
                
                // 2. Cr√©er des mouvements de sortie pour toutes les ventes
                const salesMovements = [];
                sales.forEach(sale => {
                    // Trouver le produit correspondant
                    const product = products.find(p => 
                        p.name === sale.productName || 
                        p._id === sale.productId ||
                        p.name.toLowerCase().includes((sale.productName || '').toLowerCase())
                    );
                    
                    if (product) {
                        const salesMovement = {
                            _id: 'sale-' + sale._id + '-' + Date.now(),
                            productId: product._id,
                            productName: product.name,
                            type: 'out',
                            quantity: sale.quantity || 1,
                            reason: 'Vente client',
                            category: product.productType || 'construction',
                            notes: `Vente √† ${sale.customerName || 'client inconnu'}`,
                            date: sale.createdAt || new Date().toISOString(),
                            createdAt: new Date().toISOString(),
                            reference: 'SALE-' + sale._id.substring(0, 8).toUpperCase(),
                            saleId: sale._id
                        };
                        salesMovements.push(salesMovement);
                    } else {
                        log(`‚ö†Ô∏è  Produit non trouv√© pour la vente: ${sale.productName}`, 'fix');
                    }
                });
                
                log(`‚úÖ ${salesMovements.length} mouvements de vente cr√©√©s`, 'fix');
                
                // 3. Combiner tous les mouvements
                const allMovements = [...existingMovements, ...initialMovements, ...salesMovements];
                
                // 4. Nettoyer les doublons
                const uniqueMovements = allMovements.filter((movement, index, self) => 
                    index === self.findIndex(m => m._id === movement._id)
                );
                
                // 5. Sauvegarder
                localStorage.setItem('stockMovements', JSON.stringify(uniqueMovements));
                
                log(`‚úÖ ${uniqueMovements.length} mouvements totaux sauvegard√©s`, 'fix');
                log(`‚úÖ Correction forc√©e termin√©e avec succ√®s!`, 'fix');
                
                updateStatus('‚úÖ Correction forc√©e appliqu√©e', 'success');
                
            } catch (error) {
                log(`‚ùå Erreur: ${error.message}`, 'fix');
                updateStatus('‚ùå Erreur lors de la correction', 'error');
            }
        }

        function createAllMovements() {
            log('‚ûï CR√âATION DE TOUS LES MOUVEMENTS:', 'fix');
            
            const products = JSON.parse(localStorage.getItem('koula_products') || '[]');
            const sales = JSON.parse(localStorage.getItem('salesData') || '[]');
            
            if (products.length === 0) {
                log('‚ùå Aucun produit trouv√©. Ajoutez des produits d\'abord.', 'fix');
                return;
            }
            
            const movements = [];
            
            // Cr√©er un mouvement initial pour chaque produit
            products.forEach(product => {
                const initialMovement = {
                    _id: 'initial-' + product._id + '-' + Date.now(),
                    productId: product._id,
                    productName: product.name,
                    type: 'in',
                    quantity: product.stock || 0,
                    reason: 'Stock initial',
                    category: product.productType || 'construction',
                    notes: 'Mouvement initial cr√©√© automatiquement',
                    date: product.createdAt || new Date().toISOString(),
                    createdAt: new Date().toISOString()
                };
                movements.push(initialMovement);
            });
            
            // Cr√©er un mouvement de sortie pour chaque vente
            sales.forEach(sale => {
                const product = products.find(p => 
                    p.name === sale.productName || 
                    p._id === sale.productId
                );
                
                if (product) {
                    const salesMovement = {
                        _id: 'sale-' + sale._id + '-' + Date.now(),
                        productId: product._id,
                        productName: product.name,
                        type: 'out',
                        quantity: sale.quantity || 1,
                        reason: 'Vente client',
                        category: product.productType || 'construction',
                        notes: `Vente √† ${sale.customerName || 'client inconnu'}`,
                        date: sale.createdAt || new Date().toISOString(),
                        createdAt: new Date().toISOString()
                    };
                    movements.push(salesMovement);
                }
            });
            
            localStorage.setItem('stockMovements', JSON.stringify(movements));
            
            log(`‚úÖ ${movements.length} mouvements cr√©√©s (${products.length} initiaux + ${sales.length} ventes)`, 'fix');
            updateStatus('Mouvements cr√©√©s', 'success');
        }

        function syncWithSales() {
            log('üîÑ SYNCHRONISATION AVEC LES VENTES:', 'fix');
            
            const products = JSON.parse(localStorage.getItem('koula_products') || '[]');
            const sales = JSON.parse(localStorage.getItem('salesData') || '[]');
            const movements = JSON.parse(localStorage.getItem('stockMovements') || '[]');
            
            // V√©rifier quelles ventes n'ont pas de mouvements correspondants
            const salesWithoutMovements = sales.filter(sale => 
                !movements.some(m => m.saleId === sale._id || 
                    (m.type === 'out' && m.reason === 'Vente client' && 
                     m.productName === sale.productName && 
                     m.quantity === (sale.quantity || 1)))
            );
            
            if (salesWithoutMovements.length > 0) {
                log(`üìä ${salesWithoutMovements.length} ventes sans mouvements trouv√©es`, 'fix');
                
                const newMovements = salesWithoutMovements.map(sale => {
                    const product = products.find(p => 
                        p.name === sale.productName || p._id === sale.productId
                    );
                    
                    if (product) {
                        return {
                            _id: 'sync-sale-' + sale._id + '-' + Date.now(),
                            productId: product._id,
                            productName: product.name,
                            type: 'out',
                            quantity: sale.quantity || 1,
                            reason: 'Vente client',
                            category: product.productType || 'construction',
                            notes: `Vente synchronis√©e - ${sale.customerName || 'client inconnu'}`,
                            date: sale.createdAt || new Date().toISOString(),
                            createdAt: new Date().toISOString(),
                            saleId: sale._id
                        };
                    }
                    return null;
                }).filter(Boolean);
                
                const allMovements = [...movements, ...newMovements];
                localStorage.setItem('stockMovements', JSON.stringify(allMovements));
                
                log(`‚úÖ ${newMovements.length} mouvements de vente synchronis√©s`, 'fix');
                updateStatus('Synchronisation termin√©e', 'success');
            } else {
                log('‚úÖ Toutes les ventes ont d√©j√† des mouvements correspondants', 'fix');
                updateStatus('Synchronisation d√©j√† √† jour', 'success');
            }
        }

        function showCorrectedStats() {
            log('üìà STATISTIQUES APR√àS CORRECTION:', 'stats');
            log('='.repeat(40), 'stats');
            
            const movements = JSON.parse(localStorage.getItem('stockMovements') || '[]');
            
            if (movements.length === 0) {
                log('‚ùå Aucun mouvement trouv√© apr√®s correction', 'stats');
                return;
            }
            
            // Calculer les statistiques
            const inMovements = movements.filter(m => m.type === 'in');
            const outMovements = movements.filter(m => m.type === 'out');
            
            const totalIn = inMovements.reduce((sum, m) => sum + (m.quantity || 0), 0);
            const totalOut = outMovements.reduce((sum, m) => sum + (m.quantity || 0), 0);
            
            const constructionMovements = movements.filter(m => m.category === 'construction');
            const electronicsMovements = movements.filter(m => m.category === 'electronics');
            
            const constructionIn = constructionMovements.filter(m => m.type === 'in').reduce((sum, m) => sum + (m.quantity || 0), 0);
            const constructionOut = constructionMovements.filter(m => m.type === 'out').reduce((sum, m) => sum + (m.quantity || 0), 0);
            
            const electronicsIn = electronicsMovements.filter(m => m.type === 'in').reduce((sum, m) => sum + (m.quantity || 0), 0);
            const electronicsOut = electronicsMovements.filter(m => m.type === 'out').reduce((sum, m) => sum + (m.quantity || 0), 0);
            
            log(`üéØ R√âSULTATS:`, 'stats');
            log(``, 'stats');
            log(`üìä ENTr√©es TOTAL: ${totalIn}`, 'stats');
            log(`üìä SORTIES TOTAL: ${totalOut}`, 'stats');
            log(`üìä STOCK TOTAL ACTUEL: ${totalIn - totalOut}`, 'stats');
            log(`üìä MOUVEMENTS TOTAL: ${movements.length}`, 'stats');
            log(``, 'stats');
            log(`üèóÔ∏è  CONSTRUCTION:`, 'stats');
            log(`   Entr√©es: ${constructionIn}`, 'stats');
            log(`   Sorties: ${constructionOut}`, 'stats');
            log(`   Stock actuel: ${constructionIn - constructionOut}`, 'stats');
            log(`   Produits: ${new Set(constructionMovements.map(m => m.productId)).size}`, 'stats');
            log(``, 'stats');
            log(`‚ö° √âLECTRONIQUE:`, 'stats');
            log(`   Entr√©es: ${electronicsIn}`, 'stats');
            log(`   Sorties: ${electronicsOut}`, 'stats');
            log(`   Stock actuel: ${electronicsIn - electronicsOut}`, 'stats');
            log(`   Produits: ${new Set(electronicsMovements.map(m => m.productId)).size}`, 'stats');
            
            // Afficher quelques exemples de mouvements
            log(``, 'stats');
            log(`üìã EXEMPLES DE MOUVEMENTS:`, 'stats');
            movements.slice(0, 5).forEach((movement, index) => {
                log(`   ${index + 1}. ${movement.productName} - ${movement.type === 'in' ? 'Entr√©e' : 'Sortie'} - ${movement.quantity} - ${movement.reason}`, 'stats');
            });
        }

        function finalTest() {
            log('üß™ TEST FINAL:', 'test');
            log('='.repeat(25), 'test');
            
            const products = JSON.parse(localStorage.getItem('koula_products') || '[]');
            const sales = JSON.parse(localStorage.getItem('salesData') || '[]');
            const movements = JSON.parse(localStorage.getItem('stockMovements') || '[]');
            
            log(`Produits: ${products.length}`, 'test');
            log(`Ventes: ${sales.length}`, 'test');
            log(`Mouvements: ${movements.length}`, 'test');
            
            if (movements.length > 0) {
                const inMovements = movements.filter(m => m.type === 'in');
                const outMovements = movements.filter(m => m.type === 'out');
                
                const totalIn = inMovements.reduce((sum, m) => sum + (m.quantity || 0), 0);
                const totalOut = outMovements.reduce((sum, m) => sum + (m.quantity || 0), 0);
                
                log(`Entr√©es: ${totalIn}`, 'test');
                log(`Sorties: ${totalOut}`, 'test');
                log(`Stock actuel: ${totalIn - totalOut}`, 'test');
                
                if (totalIn > 0 || totalOut > 0) {
                    log('‚úÖ TEST R√âUSSI - Les mouvements de stock fonctionnent!', 'test');
                    updateStatus('‚úÖ Test r√©ussi - Mouvements de stock fonctionnels', 'success');
                } else {
                    log('‚ùå TEST √âCHOU√â - Toujours des z√©ros', 'test');
                    updateStatus('‚ùå Test √©chou√©', 'error');
                }
            } else {
                log('‚ùå TEST √âCHOU√â - Aucun mouvement trouv√©', 'test');
                updateStatus('‚ùå Test √©chou√© - Aucun mouvement', 'error');
            }
        }

        function goToStockMovement() {
            window.location.href = 'http://localhost:3002/admin/stock-movements';
        }

        // Diagnostic automatique au chargement
        window.onload = function() {
            log('üöÄ Page de correction forc√©e charg√©e');
            checkCurrentState();
        };
    </script>
</body>
</html>
