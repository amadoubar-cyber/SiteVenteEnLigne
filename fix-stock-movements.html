<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Correction - Mouvements de Stock</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 20px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .button {
            background: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .button:hover {
            background: #0056b3;
        }
        .success {
            background: #28a745;
        }
        .success:hover {
            background: #218838;
        }
        .danger {
            background: #dc3545;
        }
        .danger:hover {
            background: #c82333;
        }
        .warning {
            background: #ffc107;
            color: #212529;
        }
        .warning:hover {
            background: #e0a800;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin: 20px 0;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .section {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin: 15px 0;
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Correction - Mouvements de Stock</h1>
        <p>Correction du probl√®me d'actualisation des mouvements de stock qui affichent des z√©ros.</p>
        
        <div id="status" class="status warning">
            Pr√™t √† corriger les mouvements de stock...
        </div>
        
        <div class="grid">
            <div class="section">
                <h2>üîç Diagnostic</h2>
                <button class="button" onclick="diagnoseStockIssue()">Diagnostiquer le probl√®me</button>
                <button class="button" onclick="showCurrentData()">Afficher les donn√©es actuelles</button>
                <button class="button warning" onclick="checkSync()">V√©rifier la synchronisation</button>
                <div id="diagnosis" class="log"></div>
            </div>
            
            <div class="section">
                <h2>üîß Correction</h2>
                <button class="button success" onclick="fixStockMovements()">Corriger les mouvements</button>
                <button class="button" onclick="createInitialMovements()">Cr√©er mouvements initiaux</button>
                <button class="button" onclick="syncWithProducts()">Synchroniser avec produits</button>
                <div id="fix" class="log"></div>
            </div>
        </div>
        
        <div class="section">
            <h2>üìä Donn√©es</h2>
            <button class="button" onclick="showProducts()">Afficher les produits</button>
            <button class="button" onclick="showMovements()">Afficher les mouvements</button>
            <button class="button success" onclick="addTestMovement()">Ajouter mouvement test</button>
            <button class="button danger" onclick="clearMovements()">Vider les mouvements</button>
            <div id="data" class="log"></div>
        </div>
        
        <div class="section">
            <h2>üß™ Test</h2>
            <button class="button success" onclick="testStockMovements()">Tester les mouvements</button>
            <button class="button" onclick="goToStockMovement()">Aller aux mouvements de stock</button>
            <div id="test" class="log"></div>
        </div>
    </div>

    <script>
        function log(message, targetId = 'diagnosis') {
            const logElement = document.getElementById(targetId);
            const timestamp = new Date().toLocaleTimeString();
            logElement.textContent += `[${timestamp}] ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
        }

        function updateStatus(message, type = 'warning') {
            const statusElement = document.getElementById('status');
            statusElement.textContent = message;
            statusElement.className = `status ${type}`;
        }

        function diagnoseStockIssue() {
            log('üîç DIAGNOSTIC DU PROBL√àME DE MOUVEMENTS DE STOCK');
            log('='.repeat(60));
            
            // 1. V√©rifier les produits
            const products = JSON.parse(localStorage.getItem('koula_products') || '[]');
            log(`\nüì¶ PRODUITS:`);
            log(`Total produits: ${products.length}`);
            
            if (products.length > 0) {
                const constructionProducts = products.filter(p => p.productType === 'construction');
                const electronicsProducts = products.filter(p => p.productType === 'electronics');
                
                log(`- Construction: ${constructionProducts.length} produits`);
                log(`- √âlectronique: ${electronicsProducts.length} produits`);
                
                // Afficher quelques produits
                products.slice(0, 3).forEach((product, index) => {
                    log(`  ${index + 1}. ${product.name} - Stock: ${product.stock || 0}`);
                });
            } else {
                log('‚ùå Aucun produit trouv√©');
            }
            
            // 2. V√©rifier les mouvements
            const movements = JSON.parse(localStorage.getItem('stockMovements') || '[]');
            log(`\nüìä MOUVEMENTS:`);
            log(`Total mouvements: ${movements.length}`);
            
            if (movements.length > 0) {
                const inMovements = movements.filter(m => m.type === 'in');
                const outMovements = movements.filter(m => m.type === 'out');
                
                log(`- Entr√©es: ${inMovements.length}`);
                log(`- Sorties: ${outMovements.length}`);
                
                // Afficher quelques mouvements
                movements.slice(0, 3).forEach((movement, index) => {
                    log(`  ${index + 1}. ${movement.type} - ${movement.quantity} - ${movement.reason}`);
                });
            } else {
                log('‚ùå Aucun mouvement trouv√©');
            }
            
            // 3. V√©rifier la synchronisation
            log(`\nüîó SYNCHRONISATION:`);
            if (products.length > 0 && movements.length === 0) {
                log('‚ö†Ô∏è  PROBL√àME: Produits existent mais aucun mouvement');
                log('üí° SOLUTION: Cr√©er des mouvements initiaux pour les produits');
            } else if (products.length === 0) {
                log('‚ö†Ô∏è  PROBL√àME: Aucun produit trouv√©');
                log('üí° SOLUTION: Ajouter des produits d\'abord');
            } else if (movements.length > 0) {
                log('‚úÖ Mouvements et produits synchronis√©s');
            }
            
            updateStatus('Diagnostic termin√©', 'success');
        }

        function showCurrentData() {
            log('üìä DONN√âES ACTUELLES:', 'data');
            log('='.repeat(30), 'data');
            
            const products = JSON.parse(localStorage.getItem('koula_products') || '[]');
            const movements = JSON.parse(localStorage.getItem('stockMovements') || '[]');
            
            log(`Produits: ${products.length}`, 'data');
            log(`Mouvements: ${movements.length}`, 'data');
            
            if (products.length > 0) {
                log('\nProduits:', 'data');
                products.forEach((product, index) => {
                    log(`  ${index + 1}. ${product.name} - Stock: ${product.stock || 0} - Type: ${product.productType}`, 'data');
                });
            }
            
            if (movements.length > 0) {
                log('\nMouvements:', 'data');
                movements.forEach((movement, index) => {
                    log(`  ${index + 1}. ${movement.type} - ${movement.quantity} - ${movement.reason}`, 'data');
                });
            }
        }

        function checkSync() {
            log('üîó V√âRIFICATION DE LA SYNCHRONISATION:', 'diagnosis');
            
            const products = JSON.parse(localStorage.getItem('koula_products') || '[]');
            const movements = JSON.parse(localStorage.getItem('stockMovements') || '[]');
            
            // V√©rifier si chaque produit a des mouvements
            const productsWithMovements = [];
            const productsWithoutMovements = [];
            
            products.forEach(product => {
                const productMovements = movements.filter(m => m.productId === product._id);
                if (productMovements.length > 0) {
                    productsWithMovements.push(product);
                } else {
                    productsWithoutMovements.push(product);
                }
            });
            
            log(`Produits avec mouvements: ${productsWithMovements.length}`, 'diagnosis');
            log(`Produits sans mouvements: ${productsWithoutMovements.length}`, 'diagnosis');
            
            if (productsWithoutMovements.length > 0) {
                log('\nProduits sans mouvements:', 'diagnosis');
                productsWithoutMovements.forEach(product => {
                    log(`  - ${product.name} (Stock: ${product.stock || 0})`, 'diagnosis');
                });
            }
        }

        function fixStockMovements() {
            log('üîß CORRECTION DES MOUVEMENTS DE STOCK:', 'fix');
            log('='.repeat(45), 'fix');
            
            try {
                const products = JSON.parse(localStorage.getItem('koula_products') || '[]');
                const movements = JSON.parse(localStorage.getItem('stockMovements') || '[]');
                
                // 1. Nettoyer les mouvements orphelins (sans produit correspondant)
                const validProductIds = products.map(p => p._id);
                const validMovements = movements.filter(m => validProductIds.includes(m.productId));
                
                if (validMovements.length !== movements.length) {
                    localStorage.setItem('stockMovements', JSON.stringify(validMovements));
                    log(`‚úÖ ${movements.length - validMovements.length} mouvements orphelins supprim√©s`, 'fix');
                }
                
                // 2. Cr√©er des mouvements initiaux pour les produits sans mouvements
                const productsWithoutMovements = products.filter(product => 
                    !validMovements.some(m => m.productId === product._id)
                );
                
                if (productsWithoutMovements.length > 0) {
                    const newMovements = productsWithoutMovements.map(product => ({
                        _id: 'initial-' + product._id + '-' + Date.now(),
                        productId: product._id,
                        productName: product.name,
                        type: 'in',
                        quantity: product.stock || 0,
                        reason: 'Stock initial',
                        category: product.productType || 'construction',
                        notes: 'Mouvement initial cr√©√© automatiquement',
                        date: product.createdAt || new Date().toISOString(),
                        createdAt: new Date().toISOString()
                    }));
                    
                    const allMovements = [...validMovements, ...newMovements];
                    localStorage.setItem('stockMovements', JSON.stringify(allMovements));
                    
                    log(`‚úÖ ${newMovements.length} mouvements initiaux cr√©√©s`, 'fix');
                }
                
                // 3. V√©rifier la coh√©rence des donn√©es
                const finalMovements = JSON.parse(localStorage.getItem('stockMovements') || '[]');
                const inTotal = finalMovements.filter(m => m.type === 'in').reduce((sum, m) => sum + (m.quantity || 0), 0);
                const outTotal = finalMovements.filter(m => m.type === 'out').reduce((sum, m) => sum + (m.quantity || 0), 0);
                
                log(`‚úÖ Entr√©es totales: ${inTotal}`, 'fix');
                log(`‚úÖ Sorties totales: ${outTotal}`, 'fix');
                log(`‚úÖ Mouvements totaux: ${finalMovements.length}`, 'fix');
                
                updateStatus('Correction appliqu√©e avec succ√®s', 'success');
                
            } catch (error) {
                log(`‚ùå Erreur: ${error.message}`, 'fix');
                updateStatus('Erreur lors de la correction', 'error');
            }
        }

        function createInitialMovements() {
            log('‚ûï CR√âATION DE MOUVEMENTS INITIAUX:', 'fix');
            
            const products = JSON.parse(localStorage.getItem('koula_products') || '[]');
            const movements = JSON.parse(localStorage.getItem('stockMovements') || '[]');
            
            if (products.length === 0) {
                log('‚ùå Aucun produit trouv√©. Ajoutez des produits d\'abord.', 'fix');
                return;
            }
            
            const newMovements = products.map(product => ({
                _id: 'initial-' + product._id + '-' + Date.now(),
                productId: product._id,
                productName: product.name,
                type: 'in',
                quantity: product.stock || 0,
                reason: 'Stock initial',
                category: product.productType || 'construction',
                notes: 'Mouvement initial cr√©√© automatiquement',
                date: product.createdAt || new Date().toISOString(),
                createdAt: new Date().toISOString()
            }));
            
            const allMovements = [...movements, ...newMovements];
            localStorage.setItem('stockMovements', JSON.stringify(allMovements));
            
            log(`‚úÖ ${newMovements.length} mouvements initiaux cr√©√©s`, 'fix');
            updateStatus('Mouvements initiaux cr√©√©s', 'success');
        }

        function syncWithProducts() {
            log('üîÑ SYNCHRONISATION AVEC LES PRODUITS:', 'fix');
            
            const products = JSON.parse(localStorage.getItem('koula_products') || '[]');
            const movements = JSON.parse(localStorage.getItem('stockMovements') || '[]');
            
            // Mettre √† jour les noms des produits dans les mouvements
            const updatedMovements = movements.map(movement => {
                const product = products.find(p => p._id === movement.productId);
                if (product) {
                    return {
                        ...movement,
                        productName: product.name,
                        category: product.productType || 'construction'
                    };
                }
                return movement;
            });
            
            localStorage.setItem('stockMovements', JSON.stringify(updatedMovements));
            
            log(`‚úÖ ${updatedMovements.length} mouvements synchronis√©s`, 'fix');
            updateStatus('Synchronisation termin√©e', 'success');
        }

        function showProducts() {
            log('üì¶ PRODUITS:', 'data');
            log('='.repeat(20), 'data');
            
            const products = JSON.parse(localStorage.getItem('koula_products') || '[]');
            
            if (products.length === 0) {
                log('Aucun produit trouv√©', 'data');
            } else {
                products.forEach((product, index) => {
                    log(`${index + 1}. ${product.name}`, 'data');
                    log(`   Stock: ${product.stock || 0}`, 'data');
                    log(`   Type: ${product.productType || 'N/A'}`, 'data');
                    log(`   Cat√©gorie: ${product.category || 'N/A'}`, 'data');
                    log('', 'data');
                });
            }
        }

        function showMovements() {
            log('üìä MOUVEMENTS DE STOCK:', 'data');
            log('='.repeat(30), 'data');
            
            const movements = JSON.parse(localStorage.getItem('stockMovements') || '[]');
            
            if (movements.length === 0) {
                log('Aucun mouvement trouv√©', 'data');
            } else {
                movements.forEach((movement, index) => {
                    log(`${index + 1}. ${movement.productName || 'Produit inconnu'}`, 'data');
                    log(`   Type: ${movement.type === 'in' ? 'Entr√©e' : 'Sortie'}`, 'data');
                    log(`   Quantit√©: ${movement.quantity}`, 'data');
                    log(`   Raison: ${movement.reason}`, 'data');
                    log(`   Date: ${new Date(movement.date).toLocaleDateString()}`, 'data');
                    log('', 'data');
                });
            }
        }

        function addTestMovement() {
            const products = JSON.parse(localStorage.getItem('koula_products') || '[]');
            
            if (products.length === 0) {
                log('‚ùå Aucun produit trouv√©. Ajoutez des produits d\'abord.', 'data');
                return;
            }
            
            const product = products[0]; // Prendre le premier produit
            const movements = JSON.parse(localStorage.getItem('stockMovements') || '[]');
            
            const testMovement = {
                _id: 'test-' + Date.now(),
                productId: product._id,
                productName: product.name,
                type: 'in',
                quantity: 10,
                reason: 'Test de mouvement',
                category: product.productType || 'construction',
                notes: 'Mouvement de test cr√©√© automatiquement',
                date: new Date().toISOString(),
                createdAt: new Date().toISOString()
            };
            
            movements.push(testMovement);
            localStorage.setItem('stockMovements', JSON.stringify(movements));
            
            log(`‚úÖ Mouvement de test ajout√© pour ${product.name}`, 'data');
            updateStatus('Mouvement de test ajout√©', 'success');
        }

        function clearMovements() {
            if (confirm('√ätes-vous s√ªr de vouloir vider tous les mouvements de stock ?')) {
                localStorage.removeItem('stockMovements');
                log('‚úÖ Tous les mouvements supprim√©s', 'data');
                updateStatus('Mouvements supprim√©s', 'warning');
            }
        }

        function testStockMovements() {
            log('üß™ TEST DES MOUVEMENTS DE STOCK:', 'test');
            log('='.repeat(35), 'test');
            
            const products = JSON.parse(localStorage.getItem('koula_products') || '[]');
            const movements = JSON.parse(localStorage.getItem('stockMovements') || '[]');
            
            log(`Produits: ${products.length}`, 'test');
            log(`Mouvements: ${movements.length}`, 'test');
            
            if (products.length > 0 && movements.length > 0) {
                // Calculer les statistiques
                const inMovements = movements.filter(m => m.type === 'in');
                const outMovements = movements.filter(m => m.type === 'out');
                
                const totalIn = inMovements.reduce((sum, m) => sum + (m.quantity || 0), 0);
                const totalOut = outMovements.reduce((sum, m) => sum + (m.quantity || 0), 0);
                
                log(`Entr√©es: ${totalIn}`, 'test');
                log(`Sorties: ${totalOut}`, 'test');
                
                // V√©rifier par cat√©gorie
                const constructionMovements = movements.filter(m => m.category === 'construction');
                const electronicsMovements = movements.filter(m => m.category === 'electronics');
                
                log(`Mouvements Construction: ${constructionMovements.length}`, 'test');
                log(`Mouvements √âlectronique: ${electronicsMovements.length}`, 'test');
                
                log('‚úÖ Test termin√© avec succ√®s', 'test');
                updateStatus('‚úÖ Test r√©ussi', 'success');
                
            } else {
                log('‚ùå Donn√©es insuffisantes pour le test', 'test');
                updateStatus('‚ùå Test √©chou√©', 'error');
            }
        }

        function goToStockMovement() {
            window.location.href = '/admin/stock-movements';
        }

        // Diagnostic automatique au chargement
        window.onload = function() {
            log('üöÄ Page de correction des mouvements de stock charg√©e');
            diagnoseStockIssue();
        };
    </script>
</body>
</html>
