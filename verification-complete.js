/**
 * Script de v√©rification compl√®te du projet Bowoye
 * V√©rifie tous les aspects du projet avant d√©ploiement
 */

const fs = require('fs');
const path = require('path');

console.log('üîç V√âRIFICATION COMPL√àTE DU PROJET BOWOYE\n');
console.log('='.repeat(60));

const checks = [];
let criticalErrors = 0;
let warnings = 0;

// ===== SECTION 1: FICHIERS ESSENTIELS =====
console.log('\nüìÅ SECTION 1: V√âRIFICATION DES FICHIERS ESSENTIELS\n');

const essentialFiles = [
  // Backend
  { path: 'server/package.json', type: 'Backend', critical: true },
  { path: 'server/index.js', type: 'Backend', critical: true },
  { path: 'server/config/database.js', type: 'Backend', critical: true },
  { path: 'render.yaml', type: 'Deployment', critical: true },
  
  // Frontend
  { path: 'client/package.json', type: 'Frontend', critical: true },
  { path: 'client/src/App.js', type: 'Frontend', critical: true },
  { path: 'client/src/services/api.js', type: 'Frontend', critical: true },
  { path: 'client/src/config/env.js', type: 'Frontend', critical: true },
];

essentialFiles.forEach(file => {
  const exists = fs.existsSync(file.path);
  if (exists) {
    console.log(`‚úÖ ${file.type}: ${file.path}`);
    checks.push({ section: 'Fichiers', name: file.path, status: true });
  } else {
    console.log(`‚ùå ${file.type}: ${file.path} - MANQUANT`);
    checks.push({ section: 'Fichiers', name: file.path, status: false });
    if (file.critical) criticalErrors++;
  }
});

// ===== SECTION 2: CONFIGURATION BACKEND =====
console.log('\nüñ•Ô∏è  SECTION 2: CONFIGURATION BACKEND\n');

try {
  // V√©rifier server/package.json
  const serverPackage = JSON.parse(fs.readFileSync('server/package.json', 'utf8'));
  
  const requiredDeps = {
    'express': 'Framework web',
    'mongoose': 'Base de donn√©es MongoDB',
    'cors': 'Cross-Origin Resource Sharing',
    'dotenv': 'Variables d\'environnement',
    'jsonwebtoken': 'Authentification JWT',
    'bcryptjs': 'Hash des mots de passe'
  };
  
  Object.entries(requiredDeps).forEach(([dep, description]) => {
    if (serverPackage.dependencies && serverPackage.dependencies[dep]) {
      console.log(`‚úÖ ${dep}: ${serverPackage.dependencies[dep]} - ${description}`);
      checks.push({ section: 'Backend Deps', name: dep, status: true });
    } else {
      console.log(`‚ùå ${dep}: MANQUANT - ${description}`);
      checks.push({ section: 'Backend Deps', name: dep, status: false });
      criticalErrors++;
    }
  });
  
  // V√©rifier les scripts
  console.log('\nüìú Scripts Backend:');
  if (serverPackage.scripts) {
    console.log(`   start: ${serverPackage.scripts.start || 'NON D√âFINI'}`);
    if (!serverPackage.scripts.start) warnings++;
  }
  
} catch (error) {
  console.log('‚ùå Erreur lecture server/package.json:', error.message);
  criticalErrors++;
}

// ===== SECTION 3: CONFIGURATION FRONTEND =====
console.log('\nüíª SECTION 3: CONFIGURATION FRONTEND\n');

try {
  const clientPackage = JSON.parse(fs.readFileSync('client/package.json', 'utf8'));
  
  const requiredClientDeps = {
    'react': 'Framework React',
    'react-router-dom': 'Routing',
    'axios': 'Requ√™tes HTTP'
  };
  
  Object.entries(requiredClientDeps).forEach(([dep, description]) => {
    if (clientPackage.dependencies && clientPackage.dependencies[dep]) {
      console.log(`‚úÖ ${dep}: ${clientPackage.dependencies[dep]} - ${description}`);
      checks.push({ section: 'Frontend Deps', name: dep, status: true });
    } else {
      console.log(`‚ùå ${dep}: MANQUANT - ${description}`);
      checks.push({ section: 'Frontend Deps', name: dep, status: false });
      criticalErrors++;
    }
  });
  
} catch (error) {
  console.log('‚ùå Erreur lecture client/package.json:', error.message);
  criticalErrors++;
}

// ===== SECTION 4: CONFIGURATION API =====
console.log('\nüîó SECTION 4: CONFIGURATION DES URLs API\n');

try {
  // V√©rifier client/src/config/env.js
  const envConfig = fs.readFileSync('client/src/config/env.js', 'utf8');
  
  // V√©rifier les URLs
  if (envConfig.includes('bowoye-backend-5nd0.onrender.com')) {
    console.log('‚úÖ URL Backend Render: bowoye-backend-5nd0.onrender.com');
    checks.push({ section: 'API URLs', name: 'Backend URL', status: true });
  } else if (envConfig.includes('bowoye-backend.onrender.com')) {
    console.log('‚ö†Ô∏è  Ancienne URL Backend trouv√©e (devrait √™tre bowoye-backend-5nd0)');
    warnings++;
  } else {
    console.log('‚ùå URL Backend Render non trouv√©e');
    criticalErrors++;
  }
  
  // V√©rifier client/src/services/api.js
  const apiFile = fs.readFileSync('client/src/services/api.js', 'utf8');
  
  if (apiFile.includes('localhost:3001') || apiFile.includes('localhost:5000')) {
    console.log('‚úÖ Configuration locale pr√©sente pour d√©veloppement');
  }
  
  if (apiFile.includes('bowoye-backend-5nd0.onrender.com')) {
    console.log('‚úÖ Configuration production pr√©sente');
  }
  
} catch (error) {
  console.log('‚ùå Erreur v√©rification configuration API:', error.message);
  criticalErrors++;
}

// ===== SECTION 5: MOD√àLES DE DONN√âES =====
console.log('\nüìä SECTION 5: MOD√àLES DE DONN√âES (MODELS)\n');

const models = [
  'server/models/User.js',
  'server/models/Product.js',
  'server/models/Order.js',
  'server/models/Category.js'
];

models.forEach(model => {
  const exists = fs.existsSync(model);
  const modelName = path.basename(model, '.js');
  if (exists) {
    console.log(`‚úÖ Mod√®le ${modelName} existe`);
    checks.push({ section: 'Models', name: modelName, status: true });
  } else {
    console.log(`‚ö†Ô∏è  Mod√®le ${modelName} manquant`);
    warnings++;
  }
});

// ===== SECTION 6: ROUTES API =====
console.log('\nüõ£Ô∏è  SECTION 6: ROUTES API\n');

const routes = [
  'server/routes/auth.js',
  'server/routes/products.js',
  'server/routes/orders.js',
  'server/routes/categories.js'
];

routes.forEach(route => {
  const exists = fs.existsSync(route);
  const routeName = path.basename(route, '.js');
  if (exists) {
    console.log(`‚úÖ Route ${routeName} existe`);
    checks.push({ section: 'Routes', name: routeName, status: true });
  } else {
    console.log(`‚ö†Ô∏è  Route ${routeName} manquante`);
    warnings++;
  }
});

// ===== SECTION 7: V√âRIFICATION RENDER.YAML =====
console.log('\n‚òÅÔ∏è  SECTION 7: CONFIGURATION RENDER\n');

try {
  const renderConfig = fs.readFileSync('render.yaml', 'utf8');
  
  const renderChecks = [
    { key: 'bowoye-backend-5nd0', desc: 'URL backend correcte' },
    { key: 'NODE_ENV', desc: 'Variable NODE_ENV' },
    { key: 'MONGODB_URI', desc: 'Variable MONGODB_URI' },
    { key: 'JWT_SECRET', desc: 'Variable JWT_SECRET' },
    { key: 'healthCheckPath', desc: 'Health check configur√©' },
    { key: 'npm ci', desc: 'Commande build optimis√©e' }
  ];
  
  renderChecks.forEach(check => {
    if (renderConfig.includes(check.key)) {
      console.log(`‚úÖ ${check.desc}`);
      checks.push({ section: 'Render', name: check.desc, status: true });
    } else {
      console.log(`‚ùå ${check.desc} - MANQUANT`);
      checks.push({ section: 'Render', name: check.desc, status: false });
      if (check.key === 'MONGODB_URI' || check.key === 'JWT_SECRET') {
        criticalErrors++;
      } else {
        warnings++;
      }
    }
  });
  
} catch (error) {
  console.log('‚ùå Erreur lecture render.yaml:', error.message);
  criticalErrors++;
}

// ===== SECTION 8: S√âCURIT√â =====
console.log('\nüîí SECTION 8: S√âCURIT√â\n');

try {
  const serverIndex = fs.readFileSync('server/index.js', 'utf8');
  
  const securityChecks = [
    { pattern: /helmet\(/g, name: 'Helmet (s√©curit√© headers)' },
    { pattern: /cors\(/g, name: 'CORS configur√©' },
    { pattern: /rateLimit/g, name: 'Rate limiting' },
    { pattern: /trust proxy/g, name: 'Trust proxy (Render)' },
    { pattern: /express\.json\(\{.*limit/g, name: 'Limite taille requ√™tes' }
  ];
  
  securityChecks.forEach(check => {
    if (check.pattern.test(serverIndex)) {
      console.log(`‚úÖ ${check.name}`);
      checks.push({ section: 'S√©curit√©', name: check.name, status: true });
    } else {
      console.log(`‚ö†Ô∏è  ${check.name} - Non trouv√©`);
      warnings++;
    }
  });
  
} catch (error) {
  console.log('‚ùå Erreur v√©rification s√©curit√©:', error.message);
}

// ===== SECTION 9: IMAGES ET ASSETS =====
console.log('\nüñºÔ∏è  SECTION 9: CONFIGURATION IMAGES\n');

try {
  const imageUtils = fs.readFileSync('client/src/utils/imageUtils.js', 'utf8');
  
  if (imageUtils.includes('bowoye-backend-5nd0.onrender.com')) {
    console.log('‚úÖ URLs images configur√©es pour production');
  } else {
    console.log('‚ö†Ô∏è  URLs images peut-√™tre non configur√©es pour production');
    warnings++;
  }
  
  if (imageUtils.includes('localhost:3001')) {
    console.log('‚úÖ URLs images configur√©es pour d√©veloppement local');
  }
  
} catch (error) {
  console.log('‚ö†Ô∏è  Fichier imageUtils.js non trouv√©');
  warnings++;
}

// ===== SECTION 10: GIT ET D√âPLOIEMENT =====
console.log('\nüì¶ SECTION 10: GIT ET D√âPLOIEMENT\n');

// V√©rifier .gitignore
if (fs.existsSync('.gitignore')) {
  const gitignore = fs.readFileSync('.gitignore', 'utf8');
  if (gitignore.includes('node_modules')) {
    console.log('‚úÖ node_modules ignor√© dans git');
  } else {
    console.log('‚ö†Ô∏è  node_modules devrait √™tre dans .gitignore');
    warnings++;
  }
  if (gitignore.includes('.env')) {
    console.log('‚úÖ .env ignor√© dans git (s√©curit√©)');
  } else {
    console.log('‚ö†Ô∏è  .env devrait √™tre dans .gitignore');
    warnings++;
  }
} else {
  console.log('‚ö†Ô∏è  Fichier .gitignore manquant');
  warnings++;
}

// ===== R√âSUM√â FINAL =====
console.log('\n' + '='.repeat(60));
console.log('üìä R√âSUM√â DE LA V√âRIFICATION');
console.log('='.repeat(60) + '\n');

const totalChecks = checks.length;
const passedChecks = checks.filter(c => c.status).length;
const failedChecks = checks.filter(c => !c.status).length;

console.log(`Total de v√©rifications: ${totalChecks}`);
console.log(`‚úÖ R√©ussies: ${passedChecks}`);
console.log(`‚ùå √âchou√©es: ${failedChecks}`);
console.log(`‚ö†Ô∏è  Avertissements: ${warnings}`);
console.log(`üî¥ Erreurs critiques: ${criticalErrors}`);

const successRate = ((passedChecks / totalChecks) * 100).toFixed(1);
console.log(`\nüìà Taux de r√©ussite: ${successRate}%`);

// ===== RECOMMANDATIONS =====
console.log('\n' + '='.repeat(60));
console.log('üí° RECOMMANDATIONS');
console.log('='.repeat(60) + '\n');

if (criticalErrors === 0 && warnings === 0) {
  console.log('üéâ EXCELLENT ! Votre projet est pr√™t pour le d√©ploiement !');
  console.log('\nüì§ Prochaines √©tapes:');
  console.log('   1. git add .');
  console.log('   2. git commit -m "Ready for production deployment"');
  console.log('   3. git push origin main');
  console.log('   4. Surveillez les logs Render et Vercel');
} else if (criticalErrors === 0) {
  console.log('‚úÖ Bon ! Le projet peut √™tre d√©ploy√©.');
  console.log(`‚ö†Ô∏è  Cependant, ${warnings} avertissement(s) √† consid√©rer.`);
  console.log('\nüì§ Vous pouvez d√©ployer, mais v√©rifiez les avertissements ci-dessus.');
} else {
  console.log(`‚ùå ATTENTION ! ${criticalErrors} erreur(s) critique(s) trouv√©e(s).`);
  console.log('\nüõ†Ô∏è  Corrigez les erreurs critiques avant de d√©ployer:');
  checks.filter(c => !c.status).forEach(c => {
    console.log(`   - ${c.section}: ${c.name}`);
  });
}

console.log('\n' + '='.repeat(60));
console.log('V√©rification termin√©e !');
console.log('='.repeat(60) + '\n');

// Code de sortie
process.exit(criticalErrors > 0 ? 1 : 0);

