<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagnostic Complet - Koula E-commerce</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        
        .header h1 {
            color: #2c3e50;
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .section h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.8rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            margin: 5px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }
        
        .btn.success {
            background: linear-gradient(45deg, #27ae60, #2ecc71);
        }
        
        .btn.danger {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
        }
        
        .btn.warning {
            background: linear-gradient(45deg, #f39c12, #e67e22);
        }
        
        .status {
            padding: 10px 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-weight: 600;
        }
        
        .status.success {
            background: rgba(46, 204, 113, 0.1);
            color: #27ae60;
            border-left: 4px solid #27ae60;
        }
        
        .status.error {
            background: rgba(231, 76, 60, 0.1);
            color: #e74c3c;
            border-left: 4px solid #e74c3c;
        }
        
        .status.warning {
            background: rgba(241, 196, 15, 0.1);
            color: #f39c12;
            border-left: 4px solid #f39c12;
        }
        
        .status.info {
            background: rgba(52, 152, 219, 0.1);
            color: #3498db;
            border-left: 4px solid #3498db;
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            border-left: 4px solid #667eea;
        }
        
        .card h3 {
            color: #2c3e50;
            margin-bottom: 15px;
        }
        
        .json-display {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
            margin: 10px 0;
        }
        
        .progress {
            width: 100%;
            height: 20px;
            background: #ecf0f1;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(45deg, #667eea, #764ba2);
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            color: #7f8c8d;
        }
        
        .loading::after {
            content: '';
            width: 30px;
            height: 30px;
            border: 3px solid #ecf0f1;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .fix-suggestion {
            background: rgba(52, 152, 219, 0.1);
            border: 1px solid #3498db;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }
        
        .fix-suggestion h4 {
            color: #2980b9;
            margin-bottom: 10px;
        }
        
        .fix-suggestion code {
            background: #34495e;
            color: #ecf0f1;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîß Diagnostic Complet</h1>
            <p>Koula E-commerce - Analyse et correction des probl√®mes</p>
        </div>
        
        <div class="section">
            <h2>üöÄ D√©marrage du Diagnostic</h2>
            <div class="progress">
                <div class="progress-bar" id="progressBar" style="width: 0%">0%</div>
            </div>
            <div id="diagnosticResults"></div>
        </div>
        
        <div class="section">
            <h2>‚öôÔ∏è Actions de Correction</h2>
            <button class="btn" onclick="startDiagnostic()">üîç Lancer le Diagnostic</button>
            <button class="btn success" onclick="fixCommonIssues()">üîß Corriger les Probl√®mes Courants</button>
            <button class="btn warning" onclick="optimizePerformance()">‚ö° Optimiser les Performances</button>
            <button class="btn danger" onclick="resetAllData()">üóëÔ∏è R√©initialiser Toutes les Donn√©es</button>
        </div>
        
        <div class="section">
            <h2>üìä R√©sultats du Diagnostic</h2>
            <div id="detailedResults"></div>
        </div>
    </div>

    <script>
        let diagnosticResults = {};
        let currentStep = 0;
        const totalSteps = 8;
        
        async function startDiagnostic() {
            const resultsDiv = document.getElementById('diagnosticResults');
            const progressBar = document.getElementById('progressBar');
            const detailedResults = document.getElementById('detailedResults');
            
            resultsDiv.innerHTML = '<div class="loading">D√©marrage du diagnostic...</div>';
            detailedResults.innerHTML = '';
            
            try {
                // √âtape 1: V√©rification de la connexion API
                await updateProgress(1, 'V√©rification de la connexion API...');
                await checkAPIConnection();
                
                // √âtape 2: V√©rification des donn√©es locales
                await updateProgress(2, 'V√©rification des donn√©es locales...');
                await checkLocalData();
                
                // √âtape 3: V√©rification de la structure des donn√©es
                await updateProgress(3, 'V√©rification de la structure des donn√©es...');
                await checkDataStructure();
                
                // √âtape 4: V√©rification des d√©pendances
                await updateProgress(4, 'V√©rification des d√©pendances...');
                await checkDependencies();
                
                // √âtape 5: V√©rification des performances
                await updateProgress(5, 'V√©rification des performances...');
                await checkPerformance();
                
                // √âtape 6: V√©rification de la s√©curit√©
                await updateProgress(6, 'V√©rification de la s√©curit√©...');
                await checkSecurity();
                
                // √âtape 7: V√©rification de la compatibilit√©
                await updateProgress(7, 'V√©rification de la compatibilit√©...');
                await checkCompatibility();
                
                // √âtape 8: G√©n√©ration du rapport
                await updateProgress(8, 'G√©n√©ration du rapport final...');
                await generateReport();
                
                resultsDiv.innerHTML = '<div class="status success">‚úÖ Diagnostic termin√© avec succ√®s !</div>';
                displayDetailedResults();
                
            } catch (error) {
                console.error('Erreur lors du diagnostic:', error);
                resultsDiv.innerHTML = `<div class="status error">‚ùå Erreur lors du diagnostic: ${error.message}</div>`;
            }
        }
        
        async function updateProgress(step, message) {
            currentStep = step;
            const progress = (step / totalSteps) * 100;
            const progressBar = document.getElementById('progressBar');
            progressBar.style.width = `${progress}%`;
            progressBar.textContent = `${Math.round(progress)}%`;
            
            const resultsDiv = document.getElementById('diagnosticResults');
            resultsDiv.innerHTML = `<div class="status info">üìã ${message}</div>`;
            
            // Simuler un d√©lai pour l'effet visuel
            await new Promise(resolve => setTimeout(resolve, 500));
        }
        
        async function checkAPIConnection() {
            diagnosticResults.apiConnection = {};
            
            try {
                // Test de l'API principale
                const response = await fetch('http://localhost:3001/api/health');
                const data = await response.json();
                
                if (data.success) {
                    diagnosticResults.apiConnection.status = 'success';
                    diagnosticResults.apiConnection.message = 'API connect√©e avec succ√®s';
                    diagnosticResults.apiConnection.details = data;
                } else {
                    throw new Error('API non disponible');
                }
            } catch (error) {
                diagnosticResults.apiConnection.status = 'error';
                diagnosticResults.apiConnection.message = 'Impossible de se connecter √† l\'API';
                diagnosticResults.apiConnection.error = error.message;
            }
            
            // Test des endpoints sp√©cifiques
            const endpoints = ['/products', '/orders', '/categories'];
            diagnosticResults.apiConnection.endpoints = {};
            
            for (const endpoint of endpoints) {
                try {
                    const response = await fetch(`http://localhost:3001/api${endpoint}`);
                    const data = await response.json();
                    diagnosticResults.apiConnection.endpoints[endpoint] = {
                        status: 'success',
                        data: data
                    };
                } catch (error) {
                    diagnosticResults.apiConnection.endpoints[endpoint] = {
                        status: 'error',
                        error: error.message
                    };
                }
            }
        }
        
        async function checkLocalData() {
            diagnosticResults.localData = {};
            
            try {
                const orders = JSON.parse(localStorage.getItem('clientOrders') || '[]');
                const products = JSON.parse(localStorage.getItem('koula_products') || '[]');
                const users = JSON.parse(localStorage.getItem('users') || '[]');
                
                diagnosticResults.localData = {
                    orders: {
                        count: orders.length,
                        data: orders,
                        issues: []
                    },
                    products: {
                        count: products.length,
                        data: products,
                        issues: []
                    },
                    users: {
                        count: users.length,
                        data: users,
                        issues: []
                    }
                };
                
                // V√©rifier les probl√®mes dans les donn√©es
                orders.forEach((order, index) => {
                    if (!order._id) diagnosticResults.localData.orders.issues.push(`Commande ${index}: ID manquant`);
                    if (!order.items || order.items.length === 0) diagnosticResults.localData.orders.issues.push(`Commande ${index}: Items manquants`);
                });
                
                products.forEach((product, index) => {
                    if (!product._id) diagnosticResults.localData.products.issues.push(`Produit ${index}: ID manquant`);
                    if (!product.name) diagnosticResults.localData.products.issues.push(`Produit ${index}: Nom manquant`);
                    if (typeof product.price !== 'number') diagnosticResults.localData.products.issues.push(`Produit ${index}: Prix invalide`);
                });
                
            } catch (error) {
                diagnosticResults.localData = {
                    status: 'error',
                    error: error.message
                };
            }
        }
        
        async function checkDataStructure() {
            diagnosticResults.dataStructure = {};
            
            const requiredFields = {
                orders: ['_id', 'user', 'items', 'totalAmount', 'orderStatus', 'createdAt'],
                products: ['_id', 'name', 'price', 'stock', 'productType', 'createdAt']
            };
            
            Object.keys(requiredFields).forEach(key => {
                const data = diagnosticResults.localData[key]?.data || [];
                diagnosticResults.dataStructure[key] = {
                    total: data.length,
                    valid: 0,
                    invalid: 0,
                    issues: []
                };
                
                data.forEach((item, index) => {
                    const missingFields = requiredFields[key].filter(field => !item[field]);
                    if (missingFields.length > 0) {
                        diagnosticResults.dataStructure[key].invalid++;
                        diagnosticResults.dataStructure[key].issues.push({
                            index,
                            missingFields
                        });
                    } else {
                        diagnosticResults.dataStructure[key].valid++;
                    }
                });
            });
        }
        
        async function checkDependencies() {
            diagnosticResults.dependencies = {
                localStorage: typeof Storage !== 'undefined',
                fetch: typeof fetch !== 'undefined',
                json: typeof JSON !== 'undefined',
                console: typeof console !== 'undefined'
            };
        }
        
        async function checkPerformance() {
            diagnosticResults.performance = {};
            
            // Test de performance localStorage
            const startTime = performance.now();
            try {
                const largeData = new Array(1000).fill({ test: 'data' });
                localStorage.setItem('performance_test', JSON.stringify(largeData));
                localStorage.removeItem('performance_test');
                diagnosticResults.performance.localStorage = {
                    status: 'success',
                    time: performance.now() - startTime
                };
            } catch (error) {
                diagnosticResults.performance.localStorage = {
                    status: 'error',
                    error: error.message
                };
            }
            
            // Test de performance API
            const apiStartTime = performance.now();
            try {
                await fetch('http://localhost:3001/api/health');
                diagnosticResults.performance.api = {
                    status: 'success',
                    time: performance.now() - apiStartTime
                };
            } catch (error) {
                diagnosticResults.performance.api = {
                    status: 'error',
                    time: performance.now() - apiStartTime,
                    error: error.message
                };
            }
        }
        
        async function checkSecurity() {
            diagnosticResults.security = {
                https: window.location.protocol === 'https:',
                localStorage: true, // localStorage est disponible
                cookies: navigator.cookieEnabled,
                userAgent: navigator.userAgent
            };
        }
        
        async function checkCompatibility() {
            diagnosticResults.compatibility = {
                browser: getBrowserInfo(),
                screen: {
                    width: screen.width,
                    height: screen.height,
                    colorDepth: screen.colorDepth
                },
                viewport: {
                    width: window.innerWidth,
                    height: window.innerHeight
                },
                features: {
                    es6: typeof Symbol !== 'undefined',
                    promises: typeof Promise !== 'undefined',
                    arrowFunctions: true, // Si le code s'ex√©cute, c'est support√©
                    modules: typeof import !== 'undefined'
                }
            };
        }
        
        function getBrowserInfo() {
            const userAgent = navigator.userAgent;
            let browserName = 'Unknown';
            
            if (userAgent.includes('Chrome')) browserName = 'Chrome';
            else if (userAgent.includes('Firefox')) browserName = 'Firefox';
            else if (userAgent.includes('Safari')) browserName = 'Safari';
            else if (userAgent.includes('Edge')) browserName = 'Edge';
            
            return {
                name: browserName,
                version: userAgent,
                mobile: /Mobile|Android|iPhone|iPad/.test(userAgent)
            };
        }
        
        async function generateReport() {
            diagnosticResults.report = {
                timestamp: new Date().toISOString(),
                summary: {
                    totalIssues: 0,
                    criticalIssues: 0,
                    warnings: 0,
                    suggestions: 0
                },
                recommendations: []
            };
            
            // Compter les probl√®mes
            if (diagnosticResults.apiConnection?.status === 'error') {
                diagnosticResults.report.summary.criticalIssues++;
                diagnosticResults.report.recommendations.push({
                    type: 'critical',
                    title: 'Probl√®me de connexion API',
                    description: 'L\'API n\'est pas accessible. V√©rifiez que le serveur est d√©marr√©.',
                    action: 'D√©marrer le serveur avec npm run dev dans le dossier server'
                });
            }
            
            // Analyser les donn√©es
            Object.keys(diagnosticResults.dataStructure || {}).forEach(key => {
                const structure = diagnosticResults.dataStructure[key];
                if (structure.invalid > 0) {
                    diagnosticResults.report.summary.warnings++;
                    diagnosticResults.report.recommendations.push({
                        type: 'warning',
                        title: `Donn√©es ${key} invalides`,
                        description: `${structure.invalid} ${key} ont des champs manquants`,
                        action: 'Utiliser la fonction de correction des donn√©es'
                    });
                }
            });
        }
        
        function displayDetailedResults() {
            const detailedResults = document.getElementById('detailedResults');
            
            let html = '<div class="grid">';
            
            // R√©sum√©
            html += `
                <div class="card">
                    <h3>üìä R√©sum√©</h3>
                    <div class="status ${diagnosticResults.report?.summary.criticalIssues > 0 ? 'error' : 'success'}">
                        Probl√®mes critiques: ${diagnosticResults.report?.summary.criticalIssues || 0}
                    </div>
                    <div class="status ${diagnosticResults.report?.summary.warnings > 0 ? 'warning' : 'success'}">
                        Avertissements: ${diagnosticResults.report?.summary.warnings || 0}
                    </div>
                    <div class="status info">
                        Recommandations: ${diagnosticResults.report?.recommendations?.length || 0}
                    </div>
                </div>
            `;
            
            // Connexion API
            html += `
                <div class="card">
                    <h3>üîó Connexion API</h3>
                    <div class="status ${diagnosticResults.apiConnection?.status === 'success' ? 'success' : 'error'}">
                        ${diagnosticResults.apiConnection?.message || 'Erreur de connexion'}
                    </div>
                    ${diagnosticResults.apiConnection?.endpoints ? 
                        Object.keys(diagnosticResults.apiConnection.endpoints).map(endpoint => 
                            `<div class="status ${diagnosticResults.apiConnection.endpoints[endpoint].status === 'success' ? 'success' : 'error'}">
                                ${endpoint}: ${diagnosticResults.apiConnection.endpoints[endpoint].status === 'success' ? 'OK' : 'Erreur'}
                            </div>`
                        ).join('') : ''
                    }
                </div>
            `;
            
            // Donn√©es locales
            html += `
                <div class="card">
                    <h3>üíæ Donn√©es Locales</h3>
                    ${diagnosticResults.localData ? 
                        Object.keys(diagnosticResults.localData).map(key => 
                            `<div class="status ${diagnosticResults.localData[key].issues?.length > 0 ? 'warning' : 'success'}">
                                ${key}: ${diagnosticResults.localData[key].count || 0} √©l√©ments
                                ${diagnosticResults.localData[key].issues?.length > 0 ? ` (${diagnosticResults.localData[key].issues.length} probl√®mes)` : ''}
                            </div>`
                        ).join('') : '<div class="status error">Donn√©es non disponibles</div>'
                    }
                </div>
            `;
            
            // Performance
            html += `
                <div class="card">
                    <h3>‚ö° Performance</h3>
                    ${diagnosticResults.performance ? 
                        Object.keys(diagnosticResults.performance).map(key => 
                            `<div class="status ${diagnosticResults.performance[key].status === 'success' ? 'success' : 'error'}">
                                ${key}: ${diagnosticResults.performance[key].time ? Math.round(diagnosticResults.performance[key].time) + 'ms' : 'N/A'}
                            </div>`
                        ).join('') : '<div class="status error">Tests de performance non disponibles</div>'
                    }
                </div>
            `;
            
            html += '</div>';
            
            // Recommandations
            if (diagnosticResults.report?.recommendations?.length > 0) {
                html += '<div class="section"><h2>üí° Recommandations</h2>';
                diagnosticResults.report.recommendations.forEach(rec => {
                    html += `
                        <div class="fix-suggestion">
                            <h4>${rec.title}</h4>
                            <p>${rec.description}</p>
                            <p><strong>Action:</strong> ${rec.action}</p>
                        </div>
                    `;
                });
                html += '</div>';
            }
            
            // Donn√©es brutes
            html += `
                <div class="section">
                    <h2>üîç Donn√©es Brutes du Diagnostic</h2>
                    <div class="json-display">${JSON.stringify(diagnosticResults, null, 2)}</div>
                </div>
            `;
            
            detailedResults.innerHTML = html;
        }
        
        async function fixCommonIssues() {
            const results = [];
            
            try {
                // Corriger les donn√©es des commandes
                const orders = JSON.parse(localStorage.getItem('clientOrders') || '[]');
                const fixedOrders = orders.map(order => ({
                    ...order,
                    _id: order._id || `order_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                    totalAmount: order.totalAmount || (order.items?.reduce((sum, item) => sum + (item.price * item.quantity), 0) || 0),
                    orderStatus: order.orderStatus || 'pending',
                    createdAt: order.createdAt || new Date().toISOString()
                }));
                localStorage.setItem('clientOrders', JSON.stringify(fixedOrders));
                results.push('‚úÖ Commandes corrig√©es');
                
                // Corriger les donn√©es des produits
                const products = JSON.parse(localStorage.getItem('koula_products') || '[]');
                const fixedProducts = products.map(product => ({
                    ...product,
                    _id: product._id || `prod_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                    price: typeof product.price === 'number' ? product.price : 0,
                    stock: typeof product.stock === 'number' ? product.stock : 0,
                    productType: product.productType || 'general',
                    createdAt: product.createdAt || new Date().toISOString()
                }));
                localStorage.setItem('koula_products', JSON.stringify(fixedProducts));
                results.push('‚úÖ Produits corrig√©s');
                
                alert('Corrections appliqu√©es:\n\n' + results.join('\n'));
                
            } catch (error) {
                alert('Erreur lors de la correction: ' + error.message);
            }
        }
        
        async function optimizePerformance() {
            const results = [];
            
            try {
                // Nettoyer les donn√©es inutiles
                const keysToRemove = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && (key.includes('temp_') || key.includes('cache_'))) {
                        keysToRemove.push(key);
                    }
                }
                
                keysToRemove.forEach(key => localStorage.removeItem(key));
                results.push(`‚úÖ ${keysToRemove.length} entr√©es temporaires supprim√©es`);
                
                // Optimiser les donn√©es
                const orders = JSON.parse(localStorage.getItem('clientOrders') || '[]');
                const optimizedOrders = orders.map(order => ({
                    _id: order._id,
                    user: order.user ? { firstName: order.user.firstName, lastName: order.user.lastName } : null,
                    items: order.items,
                    totalAmount: order.totalAmount,
                    orderStatus: order.orderStatus,
                    createdAt: order.createdAt
                }));
                localStorage.setItem('clientOrders', JSON.stringify(optimizedOrders));
                results.push('‚úÖ Donn√©es optimis√©es');
                
                alert('Optimisations appliqu√©es:\n\n' + results.join('\n'));
                
            } catch (error) {
                alert('Erreur lors de l\'optimisation: ' + error.message);
            }
        }
        
        function resetAllData() {
            if (confirm('√ätes-vous s√ªr de vouloir r√©initialiser TOUTES les donn√©es ? Cette action est irr√©versible.')) {
                localStorage.clear();
                sessionStorage.clear();
                alert('Toutes les donn√©es ont √©t√© supprim√©es. La page va se recharger.');
                window.location.reload();
            }
        }
        
        // D√©marrer le diagnostic automatiquement au chargement
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(startDiagnostic, 1000);
        });
    </script>
</body>
</html>
