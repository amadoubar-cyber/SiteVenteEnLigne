<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Correction D√©finitive - Persistance des Produits</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .success {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .warning {
            background: #fff3cd;
            color: #856404;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover {
            background: #0056b3;
        }
        .danger {
            background: #dc3545;
        }
        .danger:hover {
            background: #c82333;
        }
        .success-btn {
            background: #28a745;
        }
        .success-btn:hover {
            background: #218838;
        }
        .warning-btn {
            background: #ffc107;
            color: #212529;
        }
        .warning-btn:hover {
            background: #e0a800;
        }
        .diagnostic-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
            border-left: 4px solid #007bff;
        }
        .product-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
        }
        .product-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #eee;
            background: white;
            margin: 5px 0;
            border-radius: 4px;
        }
        .product-info {
            flex: 1;
        }
        .product-name {
            font-weight: bold;
            color: #333;
        }
        .product-details {
            font-size: 12px;
            color: #666;
            margin-top: 2px;
        }
        .product-actions {
            display: flex;
            gap: 5px;
        }
        .btn-small {
            padding: 4px 8px;
            font-size: 12px;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid #007bff;
            text-align: center;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }
        .stat-label {
            color: #666;
            font-size: 14px;
        }
        .code-block {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Correction D√©finitive - Persistance des Produits</h1>
        <p>Ce script corrige d√©finitivement le probl√®me de persistance des produits dans l'admin.</p>
        
        <div class="warning">
            <strong>‚ö†Ô∏è Probl√®me Identifi√© :</strong> Conflits entre plusieurs syst√®mes de stockage et initialisations automatiques qui √©crasent les donn√©es.
        </div>

        <div class="diagnostic-section">
            <h3>üîç Diagnostic Actuel</h3>
            <div class="stats-grid" id="diagnosticStats"></div>
        </div>

        <div class="diagnostic-section">
            <h3>üìã Actions de Correction</h3>
            <button onclick="diagnoseProblem()" class="success-btn">
                üîç Diagnostiquer le Probl√®me
            </button>
            <button onclick="fixProductPersistence()" class="success-btn">
                üîß Corriger la Persistance
            </button>
            <button onclick="createTestProduct()" class="warning-btn">
                üì¶ Cr√©er Produit Test
            </button>
            <button onclick="verifyFix()" class="success-btn">
                ‚úÖ V√©rifier la Correction
            </button>
            <button onclick="clearAllData()" class="danger">
                üóëÔ∏è Nettoyer Toutes les Donn√©es
            </button>
        </div>

        <div class="diagnostic-section">
            <h3>üìä Produits Actuels</h3>
            <div class="product-list" id="productList">
                <p>Cliquez sur "Diagnostiquer le Probl√®me" pour voir les produits.</p>
            </div>
        </div>

        <div class="diagnostic-section">
            <h3>üîß Code de Correction</h3>
            <p>Copiez-collez ce code dans la console de votre navigateur pour corriger manuellement :</p>
            <div class="code-block" id="fixCode">
                // Code de correction sera g√©n√©r√© ici
            </div>
        </div>
    </div>

    <script>
        // Diagnostic et correction du probl√®me de persistance des produits
        class ProductPersistenceFixer {
            constructor() {
                this.storageKeys = [
                    'koula_products',
                    'products',
                    'adminProducts',
                    'productsData',
                    'testProducts',
                    'defaultProducts'
                ];
                this.init();
            }

            init() {
                this.diagnoseProblem();
            }

            // Diagnostiquer le probl√®me
            diagnoseProblem() {
                console.log('üîç Diagnostic du probl√®me de persistance des produits...');
                
                const stats = {
                    totalKeys: 0,
                    totalProducts: 0,
                    conflicts: 0,
                    emptyKeys: 0,
                    duplicateProducts: 0
                };

                const allProducts = [];
                const keyData = {};

                // Analyser chaque cl√© de stockage
                this.storageKeys.forEach(key => {
                    const data = localStorage.getItem(key);
                    if (data) {
                        try {
                            const parsed = JSON.parse(data);
                            keyData[key] = parsed;
                            stats.totalKeys++;
                            
                            if (Array.isArray(parsed)) {
                                stats.totalProducts += parsed.length;
                                allProducts.push(...parsed);
                            } else if (parsed.products && Array.isArray(parsed.products)) {
                                stats.totalProducts += parsed.products.length;
                                allProducts.push(...parsed.products);
                            }
                        } catch (error) {
                            console.error(`Erreur parsing ${key}:`, error);
                            stats.conflicts++;
                        }
                    } else {
                        stats.emptyKeys++;
                    }
                });

                // D√©tecter les doublons
                const productIds = allProducts.map(p => p._id || p.id);
                const uniqueIds = new Set(productIds);
                stats.duplicateProducts = productIds.length - uniqueIds.size;

                this.displayDiagnostic(stats, keyData, allProducts);
                this.generateFixCode(keyData);
            }

            displayDiagnostic(stats, keyData, allProducts) {
                const statsGrid = document.getElementById('diagnosticStats');
                statsGrid.innerHTML = `
                    <div class="stat-card">
                        <div class="stat-value">${stats.totalKeys}</div>
                        <div class="stat-label">Cl√©s de Stockage</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${stats.totalProducts}</div>
                        <div class="stat-label">Produits Totaux</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${stats.conflicts}</div>
                        <div class="stat-label">Conflits</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${stats.emptyKeys}</div>
                        <div class="stat-label">Cl√©s Vides</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${stats.duplicateProducts}</div>
                        <div class="stat-label">Doublons</div>
                    </div>
                `;

                // Afficher les produits
                const productList = document.getElementById('productList');
                if (allProducts.length > 0) {
                    productList.innerHTML = allProducts.map((product, index) => `
                        <div class="product-item">
                            <div class="product-info">
                                <div class="product-name">${product.name || 'Produit sans nom'}</div>
                                <div class="product-details">
                                    ID: ${product._id || product.id || 'N/A'} | 
                                    Prix: ${product.price ? product.price.toLocaleString() : 'N/A'} FG | 
                                    Stock: ${product.stock || 'N/A'}
                                </div>
                            </div>
                            <div class="product-actions">
                                <button onclick="removeProduct('${product._id || product.id}')" class="btn-small danger">
                                    Supprimer
                                </button>
                            </div>
                        </div>
                    `).join('');
                } else {
                    productList.innerHTML = '<p class="info">Aucun produit trouv√© dans le stockage.</p>';
                }
            }

            generateFixCode(keyData) {
                const fixCode = `
// CORRECTION D√âFINITIVE - Persistance des Produits
// Copiez et ex√©cutez ce code dans la console du navigateur

console.log('üîß D√©but de la correction...');

// 1. Nettoyer toutes les cl√©s de stockage conflictuelles
const keysToClean = ['products', 'adminProducts', 'productsData', 'testProducts', 'defaultProducts'];
keysToClean.forEach(key => {
    localStorage.removeItem(key);
    console.log('üßπ Cl√© supprim√©e:', key);
});

// 2. Consolider tous les produits dans 'koula_products'
const allProducts = [];
${Object.keys(keyData).map(key => `
// Produits de ${key}
try {
    const ${key.replace(/[^a-zA-Z0-9]/g, '_')}Data = localStorage.getItem('${key}');
    if (${key.replace(/[^a-zA-Z0-9]/g, '_')}Data) {
        const parsed = JSON.parse(${key.replace(/[^a-zA-Z0-9]/g, '_')}Data);
        if (Array.isArray(parsed)) {
            allProducts.push(...parsed);
        } else if (parsed.products && Array.isArray(parsed.products)) {
            allProducts.push(...parsed.products);
        }
    }
} catch (e) {
    console.error('Erreur avec ${key}:', e);
}`).join('')}

// 3. Supprimer les doublons
const uniqueProducts = [];
const seenIds = new Set();

allProducts.forEach(product => {
    const id = product._id || product.id;
    if (id && !seenIds.has(id)) {
        seenIds.add(id);
        uniqueProducts.push({
            _id: id,
            name: product.name,
            description: product.description || '',
            price: parseFloat(product.price) || 0,
            stock: parseInt(product.stock) || 0,
            productType: product.productType || 'construction',
            category: product.category || 'Mat√©riaux de Construction',
            featured: Boolean(product.featured),
            isPublished: Boolean(product.isPublished),
            images: Array.isArray(product.images) ? product.images : [],
            createdAt: product.createdAt || new Date().toISOString(),
            updatedAt: new Date().toISOString()
        });
    }
});

// 4. Sauvegarder dans 'koula_products'
localStorage.setItem('koula_products', JSON.stringify(uniqueProducts));

console.log(\`‚úÖ Correction termin√©e! \${uniqueProducts.length} produits uniques sauvegard√©s.\`);
console.log('üìã Produits sauvegard√©s:', uniqueProducts);

// 5. V√©rifier la sauvegarde
const savedProducts = JSON.parse(localStorage.getItem('koula_products') || '[]');
console.log('üîç V√©rification: ' + savedProducts.length + ' produits dans koula_products');

// 6. Actualiser la page
setTimeout(() => {
    console.log('üîÑ Actualisation de la page...');
    window.location.reload();
}, 2000);
                `;

                document.getElementById('fixCode').textContent = fixCode;
            }

            // Corriger la persistance
            fixProductPersistence() {
                console.log('üîß Correction de la persistance des produits...');
                
                try {
                    // 1. Nettoyer les cl√©s conflictuelles
                    const keysToClean = ['products', 'adminProducts', 'productsData', 'testProducts', 'defaultProducts'];
                    keysToClean.forEach(key => {
                        localStorage.removeItem(key);
                        console.log('üßπ Cl√© supprim√©e:', key);
                    });

                    // 2. Consolider tous les produits
                    const allProducts = [];
                    
                    // R√©cup√©rer de koula_products
                    const koulaData = localStorage.getItem('koula_products');
                    if (koulaData) {
                        try {
                            const parsed = JSON.parse(koulaData);
                            if (Array.isArray(parsed)) {
                                allProducts.push(...parsed);
                            }
                        } catch (e) {
                            console.error('Erreur parsing koula_products:', e);
                        }
                    }

                    // 3. Supprimer les doublons et normaliser
                    const uniqueProducts = [];
                    const seenIds = new Set();

                    allProducts.forEach(product => {
                        const id = product._id || product.id;
                        if (id && !seenIds.has(id)) {
                            seenIds.add(id);
                            uniqueProducts.push({
                                _id: id,
                                name: product.name,
                                description: product.description || '',
                                price: parseFloat(product.price) || 0,
                                stock: parseInt(product.stock) || 0,
                                productType: product.productType || 'construction',
                                category: product.category || 'Mat√©riaux de Construction',
                                featured: Boolean(product.featured),
                                isPublished: Boolean(product.isPublished),
                                images: Array.isArray(product.images) ? product.images : [],
                                createdAt: product.createdAt || new Date().toISOString(),
                                updatedAt: new Date().toISOString()
                            });
                        }
                    });

                    // 4. Sauvegarder
                    localStorage.setItem('koula_products', JSON.stringify(uniqueProducts));

                    showSuccess(`‚úÖ Correction termin√©e! ${uniqueProducts.length} produits uniques sauvegard√©s.`);
                    
                    // Actualiser le diagnostic
                    setTimeout(() => {
                        this.diagnoseProblem();
                    }, 1000);

                } catch (error) {
                    console.error('Erreur lors de la correction:', error);
                    showError('Erreur lors de la correction: ' + error.message);
                }
            }

            // Cr√©er un produit test
            createTestProduct() {
                const testProduct = {
                    _id: Date.now().toString(),
                    name: 'Produit Test - ' + new Date().toLocaleTimeString(),
                    description: 'Produit cr√©√© pour tester la persistance',
                    price: 50000,
                    stock: 10,
                    productType: 'construction',
                    category: 'Mat√©riaux de Construction',
                    featured: false,
                    isPublished: true,
                    images: [],
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };

                const products = JSON.parse(localStorage.getItem('koula_products') || '[]');
                products.push(testProduct);
                localStorage.setItem('koula_products', JSON.stringify(products));

                showSuccess(`‚úÖ Produit test cr√©√©: ${testProduct.name}`);
                this.diagnoseProblem();
            }

            // V√©rifier la correction
            verifyFix() {
                const products = JSON.parse(localStorage.getItem('koula_products') || '[]');
                
                if (products.length > 0) {
                    showSuccess(`‚úÖ V√©rification r√©ussie! ${products.length} produits trouv√©s dans koula_products.`);
                    
                    // Tester la persistance en actualisant
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                } else {
                    showWarning('‚ö†Ô∏è Aucun produit trouv√©. La correction doit √™tre appliqu√©e.');
                }
            }

            // Nettoyer toutes les donn√©es
            clearAllData() {
                if (confirm('√ätes-vous s√ªr de vouloir supprimer TOUTES les donn√©es de produits ?')) {
                    this.storageKeys.forEach(key => {
                        localStorage.removeItem(key);
                    });
                    showSuccess('‚úÖ Toutes les donn√©es de produits ont √©t√© supprim√©es.');
                    this.diagnoseProblem();
                }
            }
        }

        // Initialiser le correcteur
        const fixer = new ProductPersistenceFixer();

        // Fonctions globales
        function diagnoseProblem() {
            fixer.diagnoseProblem();
        }

        function fixProductPersistence() {
            fixer.fixProductPersistence();
        }

        function createTestProduct() {
            fixer.createTestProduct();
        }

        function verifyFix() {
            fixer.verifyFix();
        }

        function clearAllData() {
            fixer.clearAllData();
        }

        function removeProduct(productId) {
            if (confirm('Supprimer ce produit ?')) {
                const products = JSON.parse(localStorage.getItem('koula_products') || '[]');
                const filtered = products.filter(p => (p._id || p.id) !== productId);
                localStorage.setItem('koula_products', JSON.stringify(filtered));
                showSuccess('Produit supprim√©.');
                fixer.diagnoseProblem();
            }
        }

        function showSuccess(message) {
            const div = document.createElement('div');
            div.className = 'success';
            div.textContent = message;
            document.querySelector('.container').appendChild(div);
            setTimeout(() => div.remove(), 5000);
        }

        function showError(message) {
            const div = document.createElement('div');
            div.className = 'error';
            div.textContent = message;
            document.querySelector('.container').appendChild(div);
            setTimeout(() => div.remove(), 5000);
        }

        function showWarning(message) {
            const div = document.createElement('div');
            div.className = 'warning';
            div.textContent = message;
            document.querySelector('.container').appendChild(div);
            setTimeout(() => div.remove(), 5000);
        }
    </script>
</body>
</html>
